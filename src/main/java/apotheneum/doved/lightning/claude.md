# Lightning Pattern Algorithm

## Overview
This file describes the algorithm for the Lightning pattern in the Apotheneum installation.

## Algorithm Description

Drawing realistic 2D lightning involves creating a jagged, branching line that simulates the path of a discharge. Several algorithms can achieve this, often incorporating randomness to capture lightning's unpredictable nature.

### 1. Midpoint Displacement Algorithm (Recommended)
This is a popular and relatively simple method:

**Initialization**: Start with a straight line segment between the bolt's origin (e.g., top of the screen) and end point (e.g., bottom of the screen).

**Recursive Displacement**:
- Choose a point (S) on the current line segment, typically near the midpoint
- Displace S randomly perpendicular to the segment by a small amount
- Recursively apply this process to the two new sub-segments created by S (from start to S, and from S to end)
- Continue this recursion until the segments become very small or a desired level of detail is reached

**Branching (Optional)**: To create the realistic branching effect, add a third line segment (a branch) from S with a small random chance during the displacement step.

### 2. L-systems (Lindenmayer Systems)
L-systems offer a powerful way to generate fractal-like structures, including lightning:

- **Define Rules**: Create a set of rules that dictate how a line segment can be replaced with more complex segments and branching structures
- **Apply Recursively**: Apply these rules iteratively to an initial line segment, creating the lightning bolt structure
- **Randomization**: Introduce randomness to the angles and lengths generated by the L-system rules to create a more organic appearance

### 3. Rapidly Exploring Random Trees (RRT)
This algorithm can also generate interesting lightning patterns:

- **Goal-Oriented Growth**: Instead of a simple recursive midpoint displacement, RRT starts at one end and grows the lightning towards a target point
- **Random Samples**: At each step, a random point near the goal is chosen, and the closest point on the existing lightning structure extends towards that random sample
- **Flexibility**: Modifying how the random points are sampled and how the lightning extends can lead to different lightning styles, including ones that wrap around obstacles

### Visual Enhancement Tips

**Jaggedness and Randomness**: Lightning rarely travels in a perfectly straight line, so introduce random deviations and sharp turns to create a natural, chaotic look.

**Branching and Subtlety**: Add thinner, secondary branches that extend from the main strike, mimicking the branching nature of real lightning. These branches can be dimmer or have a more subtle blur than the main strike.

**Corners and Thickness**: The points where the lightning changes direction can be slightly thicker or form sharp angles or even open loops with negative space inside.

**Color and Glow**: Lightning often emits a brilliant, blue-white light. Experiment with colors and add a glowing or blurred effect around the lightning bolt to enhance its visual impact.

**Animation**: Animating the lightning by rapidly changing its shape and intensity can further enhance the realism and visual appeal. 

## Implementation Notes

### Apotheneum-Specific Considerations
- The Lightning pattern should extend `ApotheneumPattern` for access to geometry utilities
- Consider using both cube faces and cylinder surfaces for 3D lightning effects
- Use `copyCubeFace()` or `copyExterior()` to mirror lightning across surfaces
- Lightning can originate from doors or travel between cube and cylinder

### Recommended Approach
1. Use **Midpoint Displacement Algorithm** for main lightning bolts
2. Generate lightning paths in 2D space, then map to 3D installation geometry
3. Support multiple simultaneous lightning strikes
4. Implement fade-out trails for realistic visual persistence

## Parameters

### Suggested Parameters
- `trig` - **TriggerParameter** to manually trigger lightning strikes (like Raindrops)
- `intensity` - Overall brightness of lightning
- `branchProbability` - Likelihood of creating branches during displacement
- `displacement` - Maximum perpendicular displacement for midpoint algorithm
- `recursionDepth` - Maximum subdivision levels for detail
- `fadeTime` - Duration for lightning trails to fade
- `color` - Lightning color (default: blue-white)
- `thickness` - Base thickness of lightning bolts
- `branchThickness` - Thickness multiplier for branches

### Trigger Implementation
Following the Raindrops pattern approach:
- Use `TriggerParameter` for manual lightning strikes
- Implement `Midi` interface for MIDI note triggers
- Create `Lightning.Bolt` inner class (similar to `Raindrops.Drop`)
- Use `LXLayer` system for individual lightning bolts
- Each triggered bolt runs independently with its own lifecycle